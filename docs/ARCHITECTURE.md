# Архитектура системы AIDrom

## Общая архитектура

AIDrom представляет собой микросервисную архитектуру для работы с AI моделями, состоящую из четырех основных компонентов:

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Gateway   │    │  Frontend   │    │     API     │    │  Database   │
│   (Nginx)   │────│   (React)   │────│  (Node.js)  │────│ (PostgreSQL)│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## Компоненты системы

### 1. Gateway (Nginx)
- **Назначение**: Обратный прокси-сервер с SSL терминацией
- **Порты**: 80 (HTTP), 443 (HTTPS)
- **Функции**:
  - Маршрутизация запросов между фронтендом и API
  - SSL сертификаты для локальной разработки
  - Логирование HTTP запросов
  - Статическая раздача файлов

### 2. Frontend (React)
- **Технологии**: React 19.1.1, TypeScript 5.8.3, Vite 7.1.2
- **Архитектура**: Feature Sliced Design (FSD)
- **Стек**: React Router 7.8.2, Tailwind CSS 4.1.12, Lucide React
- **Назначение**: Пользовательский интерфейс для управления агентами и чатами

### 3. API (Node.js)
- **Технологии**: Node.js, Express 4.19.2, TypeScript 5.9.2
- **База данных**: PostgreSQL с Drizzle ORM 0.44.4
- **Архитектура**: Трехслойная (Router → Controller → Service)
- **Назначение**: Бизнес-логика, интеграция с AI провайдерами

### 4. Database (PostgreSQL)
- **СУБД**: PostgreSQL
- **ORM**: Drizzle ORM
- **Назначение**: Хранение данных агентов, чатов, провайдеров

## Архитектура API

### Слоистая архитектура

```
┌─────────────────┐
│     Router      │ ← Маршрутизация HTTP запросов
├─────────────────┤
│   Controller    │ ← Обработка HTTP запросов/ответов
├─────────────────┤ 
│    Service      │ ← Бизнес-логика
├─────────────────┤
│   Database      │ ← Доступ к данным
└─────────────────┘
```

### Структура директорий API

```
api/src/
├── app.ts                  # Инициализация Express приложения
├── server.ts              # Запуск HTTP сервера
├── config/                # Конфигурация системы
├── router/                # HTTP маршруты
├── controllers/           # HTTP контроллеры
├── services/             # Бизнес-логика
├── db/                   # База данных
│   ├── schema/          # Схемы таблиц
│   ├── mappers/         # Преобразователи данных
│   └── types.ts         # TypeScript типы БД
├── drivers/             # Драйверы AI провайдеров
│   ├── gigachat/       # Gigachat драйвер
│   ├── deepseek/       # DeepSeek драйвер
│   └── dummy/          # Тестовый драйвер
├── middlewares/        # Express middleware
└── utils/             # Утилиты
```

## Система драйверов AI

### Поддерживаемые провайдеры

- **Gigachat**: Российская модель от Сбербанка
- **DeepSeek**: Китайская модель (deepseek-chat, deepseek-reasoner)  
- **Dummy**: Тестовый драйвер для разработки

### Интерфейс драйвера

Каждый драйвер реализует единый интерфейс:

```typescript
interface Driver {
  getInfo(): Promise<DriverInfo>
  getParamsConfig(): Promise<DriverParamsConfig>
  sendChat(request: DriverRequest): Promise<DriverResponse>
  sendGenerateImage?(request: DriverRequest): Promise<DriverResponse>
}
```

### Архитектура драйверов

```
┌─────────────────┐
│   Driver API    │ ← Единый интерфейс
├─────────────────┤
│  Driver Impl    │ ← Конкретная реализация
├─────────────────┤
│  HTTP Client    │ ← Сетевое взаимодействие
├─────────────────┤
│   AI Provider   │ ← Внешний AI сервис
└─────────────────┘
```

## Архитектура Frontend

### Feature Sliced Design (FSD)

```
front/src/
├── app/                   # Инициализация приложения
│   ├── providers/        # React провайдеры
│   └── router.tsx       # Маршрутизация
├── pages/               # Страницы приложения
├── widgets/             # Составные компоненты
├── features/            # Бизнес-функции
├── entities/            # Бизнес-сущности
└── shared/              # Переиспользуемый код
    ├── ui/             # UI компоненты
    ├── lib/            # Библиотеки
    └── api/            # API клиент
```

### Слои FSD

1. **App** - конфигурация приложения
2. **Pages** - страницы роутинга
3. **Widgets** - крупные UI блоки
4. **Features** - бизнес-функции
5. **Entities** - бизнес-сущности
6. **Shared** - переиспользуемый код

## Схема базы данных

### Основные таблицы

```sql
providers       # AI провайдеры (driver, config)
    ↓
agents         # AI агенты (name, params, rules)
    ↓
chats          # Чаты пользователей
    ↓
message_pairs  # Пары сообщений (user/assistant)

clients        # Клиенты системы
requests       # Журнал запросов к AI
agent_rules    # Правила поведения агентов
```

### Связи между таблицами

- `providers` → `agents` (1:N)
- `agents` → `chats` (1:N) 
- `agents` → `agent_rules` (1:N)
- `clients` → `chats` (1:N)
- `chats` → `message_pairs` (1:N)
- `providers` → `requests` (1:N)

## Конфигурация системы

### Переменные окружения

Система использует файл `.env` для конфигурации:

- **База данных**: `DB_*` параметры подключения
- **API**: `API_*` настройки сервера
- **Frontend**: `FRONTEND_*` конфигурация клиента
- **Gateway**: `GATEWAY_*` настройки прокси

### Docker Compose

Все сервисы оркестрируются через Docker Compose:

- Автоматическое создание сети
- Зависимости между сервисами
- Монтирование логов и данных
- SSL сертификаты для разработки

## Логирование и мониторинг

### Структура логов

```
logs/
├── api/                # Логи API сервера
│   ├── api-app-*      # Общие логи приложения
│   ├── api-api-*      # HTTP запросы
│   ├── api-controller-* # Контроллеры
│   ├── api-service-*  # Сервисы
│   └── api-database-* # База данных
├── gateway/           # Логи Nginx
└── front/            # Логи фронтенда
```

### Уровни логирования

- **ERROR**: Ошибки выполнения
- **WARN**: Предупреждения
- **INFO**: Информационные сообщения
- **DEBUG**: Отладочная информация

## Безопасность

### SSL/TLS

- Все соединения защищены SSL/TLS
- Локальные сертификаты генерируются mkcert
- Автоматическое перенаправление HTTP → HTTPS

### Аутентификация

- Клиенты идентифицируются по ID
- Изоляция данных между клиентами
- Валидация входных данных

### CORS

- Настроена политика CORS между доменами
- Разрешены только необходимые заголовки
- Ограничение методов HTTP

## Производительность

### Кэширование

- HTTP кэширование на уровне Nginx
- Кэширование статических ресурсов
- Оптимизация запросов к БД

### Оптимизации

- Индексы БД по ключевым полям
- Пагинация больших списков  
- Ленивая загрузка компонентов
- Минификация и сжатие ресурсов

## Масштабирование

### Горизонтальное масштабирование

- API сервер stateless
- Балансировка нагрузки через Nginx
- Репликация БД (master-slave)

### Вертикальное масштабирование

- Увеличение ресурсов контейнеров
- Оптимизация запросов к БД
- Тюнинг параметров PostgreSQL
