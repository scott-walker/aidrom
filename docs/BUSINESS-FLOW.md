# Бизнес-процессы AIDrom

## Общий обзор

AIDrom представляет собой платформу для работы с AI моделями через единый интерфейс. Основной бизнес-процесс включает настройку провайдеров, создание агентов и ведение диалогов с AI.

## Схема основного процесса

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Создание      │    │    Создание     │    │    Создание     │    │   Ведение       │
│   Провайдера    │───▶│    Агента       │───▶│     Чата        │───▶│   Диалога       │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 1. Создание провайдера AI

### Цель
Настройка подключения к внешнему AI сервису (Gigachat, DeepSeek и др.)

### Участники
- **Администратор системы** - настраивает провайдеров
- **Система** - валидирует подключение

### Предусловия
- Наличие API ключей от AI провайдера
- Доступ к административной панели

### Шаги процесса

#### 1.1 Выбор типа драйвера
```
Администратор → GET /providers/drivers
↓
Система возвращает список доступных драйверов:
- gigachat (Gigachat от Сбербанка)
- deepseek (DeepSeek AI)  
- dummy (Тестовый драйвер)
```

#### 1.2 Настройка конфигурации
```
Для каждого драйвера требуется специфическая конфигурация:

Gigachat:
- authorizationKey: "Bearer token для авторизации"

DeepSeek:
- apiKey: "API ключ DeepSeek"
- baseUrl: "https://api.deepseek.com" (опционально)

Dummy:
- responseTemplate: "Шаблон ответа" (опционально)
```

#### 1.3 Создание провайдера
```
Администратор → POST /providers
{
  "name": "My Gigachat Provider",
  "driver": "gigachat", 
  "description": "Основной провайдер Gigachat",
  "config": {
    "authorizationKey": "Bearer YOUR_TOKEN_HERE"
  }
}
↓
Система валидирует конфигурацию и создает провайдера
```

#### 1.4 Верификация подключения
```
Система автоматически проверяет:
- Корректность API ключей
- Доступность сервиса провайдера
- Получение списка доступных моделей
```

### Результат
- Активный провайдер готов к использованию
- Доступны модели для создания агентов

---

## 2. Создание агента AI

### Цель
Создание настроенного AI агента с индивидуальными параметрами и правилами поведения

### Участники
- **Пользователь/Администратор** - создает агента
- **Система** - валидирует параметры

### Предусловия
- Наличие активного провайдера
- Определенные требования к агенту

### Шаги процесса

#### 2.1 Выбор провайдера
```
Пользователь → GET /providers
↓
Система возвращает список активных провайдеров
↓
Пользователь выбирает подходящий провайдер
```

#### 2.2 Получение конфигурации параметров
```
Система → Провайдер.getParamsConfig()
↓
Возвращает доступные параметры для настройки:

Gigachat:
- model: ["gigachat:latest", "gigachat-pro"]
- temperature: 0.0-2.0
- maxTokens: 10-4000
- topP: 0.1-1.0  
- repetitionPenalty: 0.0-2.0

DeepSeek:
- model: ["deepseek-chat", "deepseek-reasoner"]
- temperature: 0.0-2.0
- maxTokens: 10-32000
```

#### 2.3 Настройка агента
```
Пользователь заполняет параметры агента:
- Название и описание
- Аватар (опционально)
- Модель AI
- Параметры генерации (температура, токены и т.д.)
```

#### 2.4 Создание агента
```
Пользователь → POST /agents
{
  "name": "Помощник программиста",
  "description": "AI агент для помощи в разработке",
  "providerId": 1,
  "avatar": "/static/avatars/programmer.jpg",
  "params": {
    "model": "gigachat:latest",
    "temperature": 0.7,
    "maxTokens": 2000,
    "topP": 0.9
  }
}
↓
Система создает агента и связывает с провайдером
```

#### 2.5 Настройка правил поведения
```
Пользователь добавляет правила поведения:

POST /agents/:agentId/rules
{
  "content": "Отвечай кратко и по делу"
}

POST /agents/:agentId/rules  
{
  "content": "Используй примеры кода на Python"
}

POST /agents/:agentId/rules
{
  "content": "Объясняй сложные концепции простым языком"
}
```

### Результат
- Готовый к использованию AI агент
- Настроенные правила поведения
- Связь с активным провайдером

---

## 3. Создание чата

### Цель
Инициализация диалога между пользователем и AI агентом

### Участники
- **Клиент** - пользователь системы
- **Система** - управляет чатами

### Предусловия
- Наличие активного агента
- Зарегистрированный клиент в системе

### Шаги процесса

#### 3.1 Идентификация клиента
```
Система проверяет клиента:
GET /clients/:clientId
или
GET /clients/email/:email

Если клиента нет, создается новый:
POST /clients
{
  "name": "Иван Петров",
  "email": "ivan@example.com"
}
```

#### 3.2 Выбор агента
```
Клиент → GET /agents
↓
Система возвращает список доступных агентов
↓
Клиент выбирает подходящего агента
```

#### 3.3 Создание чата
```
Клиент → POST /chats
{
  "agentId": 1,
  "clientId": 5,
  "title": "Помощь с Python"
}
↓
Система создает новый чат:
- Инициализирует пустой контекст
- Связывает агента с клиентом
- Возвращает ID чата
```

### Результат
- Активный чат готов к обмену сообщениями
- Установлена связь клиент-агент
- Инициализирован контекст диалога

---

## 4. Ведение диалога

### Цель
Обмен сообщениями между клиентом и AI агентом

### Участники
- **Клиент** - отправляет вопросы
- **AI Агент** - генерирует ответы
- **Система** - обрабатывает запросы

### Шаги процесса

#### 4.1 Отправка сообщения
```
Клиент → POST /chats/:chatId/send
{
  "message": "Как создать список в Python?"
}
```

#### 4.2 Обработка системой
```
Система выполняет:
1. Получает настройки агента
2. Формирует контекст диалога
3. Добавляет правила поведения
4. Подготавливает запрос к AI провайдеру
```

#### 4.3 Формирование запроса к AI
```
Система → AI Провайдер
{
  "model": "gigachat:latest",
  "messages": [
    {
      "role": "system", 
      "content": "Отвечай кратко и по делу. Используй примеры кода на Python."
    },
    {
      "role": "user",
      "content": "Как создать список в Python?"
    }
  ],
  "temperature": 0.7,
  "maxTokens": 2000
}
```

#### 4.4 Получение ответа
```
AI Провайдер → Система
{
  "choices": [{
    "message": {
      "role": "assistant",
      "content": "Список в Python создается с помощью квадратных скобок:\n\n```python\nmy_list = [1, 2, 3, 'hello']\n```"
    }
  }],
  "usage": {
    "promptTokens": 150,
    "completionTokens": 50
  }
}
```

#### 4.5 Сохранение и возврат
```
Система:
1. Сохраняет сообщения в контекст чата
2. Логирует запрос в журнал
3. Возвращает ответ клиенту

Клиент ← Система
{
  "userMessage": "Как создать список в Python?",
  "assistantMessage": "Список в Python создается...",
  "requestId": 123
}
```

---

## 5. Дополнительные процессы

### 5.1 Управление контекстом чата

#### Очистка контекста
```
PUT /chats/:chatId/context-clear
- Удаляет всю историю сообщений
- Сохраняет только системные правила
```

#### Оптимизация контекста  
```
PUT /chats/:chatId/context-optimize
- Сжимает длинную историю
- Удаляет устаревшие сообщения
- Сохраняет ключевую информацию
```

### 5.2 Потоковая передача (SSE)

```
GET /chats/:chatId/stream
- Открывает SSE соединение
- Передает ответы AI в реальном времени
- Используется для длинных ответов
```

### 5.3 Мониторинг и аналитика

#### Журнал запросов
```
GET /requests
- Просмотр всех запросов к AI
- Анализ использования токенов
- Мониторинг ошибок
```

#### Управление балансом
```
PATCH /clients/:clientId/balance
- Обновление баланса клиента
- Контроль лимитов использования
```

---

## 6. Схемы взаимодействия

### 6.1 Схема данных

```
Client (Клиент)
    ↓ 1:N
Chat (Чат)
    ↓ N:1
Agent (Агент)
    ↓ N:1  
Provider (Провайдер)
    ↓ 1:N
Request (Запрос)
```

### 6.2 Жизненный цикл сообщения

```
1. Клиент отправляет сообщение
2. Система валидирует права доступа
3. Загружается контекст чата и правила агента
4. Формируется запрос к AI провайдеру
5. Запрос логируется в журнал
6. AI провайдер обрабатывает запрос
7. Ответ сохраняется в контекст чата
8. Результат возвращается клиенту
9. Обновляется статистика использования
```

### 6.3 Обработка ошибок

```
Ошибки провайдера:
- Недоступность сервиса
- Превышение лимитов
- Некорректные API ключи

Ошибки системы:
- Не найден агент/чат
- Нет прав доступа
- Ошибки валидации

Восстановление:
- Повторные попытки запросов
- Переключение на резервных провайдеров
- Логирование для анализа
```
